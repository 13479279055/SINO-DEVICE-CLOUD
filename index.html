<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è®¾å¤‡é¢„çº¦ç³»ç»Ÿ - UTC+3 æ—¶åŒºå¢å¼ºç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ==========================================
        // ğŸ”¥ 1. Firebase é…ç½®
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyD3HFJZ7aJOQ7lKjKfkcWqkF3fc98HKBU4",
            authDomain: "sino-device-cloud.firebaseapp.com",
            projectId: "sino-device-cloud",
            storageBucket: "sino-device-cloud.firebasestorage.app",
            messagingSenderId: "898372256592",
            appId: "1:898372256592:web:854498445d6aa490192255"
        };

        // ==========================================
        // ğŸ”¥ 2. ç®¡ç†å‘˜é‚®ç®±è®¾ç½® (è¯·åœ¨æ­¤ä¿®æ”¹)
        // ==========================================
        const adminEmails = ["yaoguai.gis@gmail.com"]; 

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let isAdmin = false;

        // è·å– UTC+3 æ—¶é—´çš„è¾…åŠ©å‡½æ•°
        function getUTC3Date() {
            const now = new Date();
            // UTCæ—¶é—´ + 3å°æ—¶
            return new Date(now.getTime() + (3 * 60 * 60 * 1000) + (now.getTimezoneOffset() * 60000));
        }

        // --- ç™»å½•é€»è¾‘ ---
        window.login = () => signInWithPopup(auth, provider).catch(err => alert("ç™»å½•å¤±è´¥: " + err.message));
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const authSection = document.getElementById('authSection');
            const appContent = document.getElementById('appContent');
            const adminControls = document.getElementById('adminControls');
            
            if (user) {
                isAdmin = adminEmails.includes(user.email);
                authSection.innerHTML = `
                    <div class="flex items-center gap-3 bg-slate-800 p-1 pr-3 rounded-full border border-slate-700">
                        <img src="${user.photoURL}" class="w-7 h-7 rounded-full">
                        <div class="flex flex-col text-left">
                            <span class="text-[10px] font-bold text-slate-200 leading-none">${user.displayName}</span>
                            <span class="text-[9px] text-blue-400">${isAdmin ? 'ç®¡ç†å‘˜ (UTC+3)' : 'ä½¿ç”¨è€… (UTC+3)'}</span>
                        </div>
                        <button onclick="logout()" class="ml-2 text-[10px] text-slate-400 hover:text-red-400 transition">é€€å‡º</button>
                    </div>`;
                appContent.classList.remove('opacity-50', 'pointer-events-none');
                if (isAdmin) adminControls.classList.remove('hidden');
            } else {
                authSection.innerHTML = `<button onclick="login()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-bold">Google ç™»å½•</button>`;
                appContent.classList.add('opacity-50', 'pointer-events-none');
                adminControls.classList.add('hidden');
            }
        });

        // --- ç®¡ç†å‘˜æ“ä½œ ---
        window.addDevice = async () => {
            if (!isAdmin) return;
            const name = document.getElementById('deviceNameInput').value.trim();
            if (!name) return;
            await addDoc(collection(db, "devices"), { name, bookings: {}, createdAt: Date.now() });
            document.getElementById('deviceNameInput').value = '';
        };

        window.deleteDevice = async (id, name) => {
            if (isAdmin && confirm(`ç¡®å®šåˆ é™¤è®¾å¤‡ "${name}" å—ï¼Ÿ`)) {
                await deleteDoc(doc(db, "devices", id));
            }
        };

        // --- æ ¸å¿ƒé¢„çº¦é€»è¾‘ ---
        window.handleCellClick = async (deviceId, slotIndex, currentBooking) => {
            if (!currentUser) return alert("è¯·å…ˆç™»å½•");
            const deviceRef = doc(db, "devices", deviceId);
            
            if (!currentBooking) {
                // æ‰§è¡Œé¢„çº¦
                const updates = {};
                updates[`bookings.${slotIndex}`] = { 
                    uid: currentUser.uid, 
                    userName: currentUser.displayName, 
                    time: getUTC3Date().getTime() 
                };
                await updateDoc(deviceRef, updates);
            } else if (currentBooking.uid === currentUser.uid || isAdmin) {
                // å–æ¶ˆé¢„çº¦ (æœ¬äººæˆ–ç®¡ç†å‘˜)
                const promptMsg = isAdmin && currentBooking.uid !== currentUser.uid ? 
                                 `ç®¡ç†å‘˜æ“ä½œï¼šå–æ¶ˆ ${currentBooking.userName} çš„é¢„çº¦ï¼Ÿ` : "ç¡®è®¤å–æ¶ˆé¢„çº¦ï¼Ÿ";
                if (confirm(promptMsg)) {
                    const updates = {};
                    updates[`bookings.${slotIndex}`] = null;
                    await updateDoc(deviceRef, updates);
                }
            } else {
                alert(`å·²è¢« ${currentBooking.userName} å ç”¨`);
            }
        };

        // --- å®æ—¶ç›‘å¬æ¸²æŸ“ ---
        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4'];
        const getHashColor = (str) => colors[Math.abs(str.split('').reduce((a, b) => (a << 5) - a + b.charCodeAt(0), 0)) % colors.length];

        const q = query(collection(db, "devices"), orderBy("createdAt", "asc"));
        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('deviceList');
            list.innerHTML = '<div id="currentTimeLine" class="now-indicator"></div>';
            
            snapshot.forEach((doc) => {
                const device = doc.data();
                const deviceId = doc.id;
                let cells = '';
                for(let i=0; i<48; i++) {
                    const booking = (device.bookings && device.bookings[i]) ? device.bookings[i] : null;
                    const style = booking ? `background-color: ${getHashColor(booking.userName)};` : '';
                    const bookingData = booking ? JSON.stringify(booking).replace(/"/g, '&quot;') : 'null';
                    cells += `<div class="hour-cell" style="${style}" onclick="handleCellClick('${deviceId}', ${i}, ${bookingData})">
                                ${booking ? booking.userName[0] : ''}
                              </div>`;
                }

                const row = document.createElement('div');
                row.className = "flex items-center group mb-6 hover:bg-slate-50 rounded-xl p-2 transition";
                row.innerHTML = `
                    <div class="w-44 flex-shrink-0 flex items-center gap-2 pr-4">
                        ${isAdmin ? `<button onclick="deleteDevice('${deviceId}', '${device.name}')" class="text-slate-300 hover:text-red-500 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>` : ''}
                        <span class="font-bold text-slate-700 truncate text-sm">${device.name}</span>
                    </div>
                    <div class="flex-grow timeline-grid bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden relative">${cells}</div>
                `;
                list.appendChild(row);
            });
            updateTimeLine();
        });

        // --- UTC+3 æ—¶é—´æŒ‡é’ˆå¯¹é½ ---
        function updateTimeLine() {
            const utc3 = getUTC3Date();
            const minutesInDay = utc3.getHours() * 60 + utc3.getMinutes();
            const percentage = (minutesInDay / 1440) * 100;
            const line = document.getElementById('currentTimeLine');
            if(line) {
                // 11rem (w-44) æ˜¯ä¾§è¾¹æ å®½åº¦
                line.style.left = `calc(11rem + ${percentage}%)`;
            }
        }
        setInterval(updateTimeLine, 10000);
    </script>
    <style>
        .timeline-grid { display: grid; grid-template-columns: repeat(48, 1fr); min-width: 1000px; }
        .hour-cell { border-right: 1px solid #f1f5f9; height: 44px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; color: white; transition: all 0.15s; }
        .hour-cell:hover { background-color: #f8fafc; transform: scale(1.02); z-index: 10; }
        .now-indicator { position: absolute; top: 0; bottom: 0; width: 2px; background: #ef4444; z-index: 30; pointer-events: none; box-shadow: 0 0 5px rgba(239, 68, 68, 0.5); }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div class="max-w-[1500px] mx-auto p-4 md:p-8">
        <nav class="bg-slate-900 text-white px-6 py-4 rounded-3xl mb-8 flex flex-wrap justify-between items-center shadow-2xl border-b-4 border-blue-500">
            <div class="flex items-center gap-6">
                <h1 class="text-xl font-black tracking-widest uppercase">Sino <span class="text-blue-400">Time-Cloud</span></h1>
                <div id="authSection"></div>
            </div>
            <div id="adminControls" class="hidden flex gap-3"><input id="deviceNameInput" type="text" placeholder="æ–°è®¾å¤‡å" class="bg-slate-800 border-none rounded-xl px-4 py-2 text-sm text-white focus:ring-2 focus:ring-blue-500 outline-none w-48 transition-all focus:w-64"><button onclick="addDevice()" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-xl text-sm font-bold">å¢åŠ è®¾å¤‡</button></div>
        </nav>

        <div id="appContent" class="bg-white rounded-[2rem] shadow-xl border border-slate-200 p-8 overflow-hidden opacity-50 pointer-events-none transition-all">
            <div class="overflow-x-auto">
                <div class="flex mb-6 border-b border-slate-100 pb-4">
                    <div class="w-44 flex-shrink-0 text-slate-400 text-xs font-bold uppercase pl-6 text-center">UTC+03:00 æ—¶æ®µ</div>
                    <div class="flex-grow">
                        <div class="timeline-grid text-[10px] text-slate-400 font-bold">
                            <script>
                                for(let i=0; i<24; i++) {
                                    document.write(`<div class="col-span-2 text-left pl-2 border-l border-slate-100">${i}:00</div>`);
                                }
                            </script>
                        </div>
                    </div>
                </div>
                <div id="deviceList" class="relative"></div>
            </div>
        </div>
        <p class="text-center text-slate-400 text-xs mt-8 font-medium italic">å½“å‰æ˜¾ç¤ºæ—¶åŒºï¼š(UTC+03:00) Riyadh / Moscow | è‡ªåŠ¨åŒæ­¥æŒ‡é’ˆ</p>
    </div>
</body>

</html>

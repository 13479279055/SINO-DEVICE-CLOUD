<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sino Device Hub - GMT+3 Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // 1. Firebase 配置 (保持不变)
        const firebaseConfig = {
            apiKey: "AIzaSyD3HFJZ7aJOQ7lKjKfkcWqkF3fc98HKBU4",
            authDomain: "sino-device-cloud.firebaseapp.com",
            projectId: "sino-device-cloud",
            storageBucket: "sino-device-cloud.firebasestorage.app",
            messagingSenderId: "898372256592",
            appId: "1:898372256592:web:854498445d6aa490192255"
        };

        const adminEmails = ["yaoguai.gis@gmail.com"]; 
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let isAdmin = false;

        // --- GMT+3 时间逻辑 ---
        function getUTC3Time() {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            return new Date(utc + (3 * 3600000)); 
        }

        // 凌晨 12 点自动刷新
        function scheduleRefresh() {
            const now = getUTC3Time();
            const tomorrow = new Date(now);
            tomorrow.setHours(24, 0, 0, 0);
            setTimeout(() => window.location.reload(), tomorrow.getTime() - now.getTime());
        }

        // --- 核心逻辑：更新红线位置 ---
        function updateTimeLine() {
            const now = getUTC3Time();
            const minutes = now.getHours() * 60 + now.getMinutes();
            const percentage = (minutes / 1440) * 100;
            
            // 获取所有行中的指示器
            const indicators = document.querySelectorAll('.now-indicator');
            indicators.forEach(el => {
                el.style.left = `${percentage}%`;
                el.style.display = 'block';
            });
        }

        // --- 登录状态 (保持不变) ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const authSection = document.getElementById('authSection');
            const appContent = document.getElementById('appContent');
            const adminControls = document.getElementById('adminControls');
            
            if (user) {
                isAdmin = adminEmails.includes(user.email);
                authSection.innerHTML = `
                    <div class="flex items-center gap-2 bg-slate-800 p-1 pr-3 rounded-full border border-slate-700">
                        <img src="${user.photoURL}" class="w-7 h-7 rounded-full">
                        <div class="flex flex-col">
                            <span class="text-[10px] text-white font-bold leading-none">${user.displayName}</span>
                            <span class="text-[8px] text-blue-400 font-black uppercase">${isAdmin ? 'ADMIN' : 'USER'}</span>
                        </div>
                        <button onclick="logout()" class="text-[10px] text-slate-500 hover:text-red-400 ml-1">退出</button>
                    </div>`;
                appContent.classList.remove('opacity-20', 'pointer-events-none');
                adminControls.classList.toggle('hidden', !isAdmin);
                adminControls.classList.toggle('flex', isAdmin);
            } else {
                authSection.innerHTML = `<button onclick="login()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-xl text-xs font-bold transition-all">Google 登录</button>`;
                appContent.classList.add('opacity-20', 'pointer-events-none');
            }
        });

        // --- 数据渲染 ---
        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4'];
        const getHashColor = (name) => colors[Math.abs(name.split('').reduce((a, b) => (a << 5) - a + b.charCodeAt(0), 0)) % colors.length];

        const q = query(collection(db, "devices"), orderBy("createdAt", "asc"));
        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('deviceList');
            list.innerHTML = '';
            
            snapshot.forEach((docSnap) => {
                const device = docSnap.data();
                const deviceId = docSnap.id;
                let cells = '';
                
                for(let i=0; i<48; i++) {
                    const booking = (device.bookings && device.bookings[i]) ? device.bookings[i] : null;
                    const style = booking ? `background-color: ${getHashColor(booking.userName)}; opacity: 0.9;` : '';
                    const bookingData = booking ? JSON.stringify(booking).replace(/"/g, '&quot;') : 'null';
                    cells += `<div class="hour-cell" style="${style}" onclick="handleCellClick('${deviceId}', ${i}, ${bookingData})">${booking ? booking.userName[0] : ''}</div>`;
                }

                const row = document.createElement('div');
                row.className = "device-row flex items-center group border-b border-slate-100 hover:bg-blue-50/50 transition-colors";
                row.innerHTML = `
                    <div class="sticky-side w-40 flex-shrink-0 flex items-center p-3 bg-white z-10 border-r border-slate-100 shadow-[2px_0_5px_rgba(0,0,0,0.02)]">
                        ${isAdmin ? `<button onclick="deleteDevice('${deviceId}', '${device.name}')" class="mr-2 text-slate-300 hover:text-red-500 transition-colors"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>` : ''}
                        <span class="text-xs font-bold text-slate-600 truncate">${device.name}</span>
                    </div>
                    <div class="flex-grow timeline-grid relative h-10">
                        <div class="now-indicator"></div>
                        ${cells}
                    </div>
                `;
                list.appendChild(row);
            });
            updateTimeLine();
        });

        // 全局函数
        window.login = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth);
        window.deleteDevice = async (id, name) => isAdmin && confirm(`删除设备 ${name}?`) && await deleteDoc(doc(db, "devices", id));
        window.addDevice = async () => {
            const input = document.getElementById('deviceNameInput');
            if(isAdmin && input.value) {
                await addDoc(collection(db, "devices"), { name: input.value, bookings: {}, createdAt: Date.now() });
                input.value = '';
            }
        };
        window.handleCellClick = async (deviceId, slotIndex, currentBooking) => {
            if (!currentUser) return;
            const deviceRef = doc(db, "devices", deviceId);
            if (!currentBooking) {
                const updates = {};
                updates[`bookings.${slotIndex}`] = { uid: currentUser.uid, userName: currentUser.displayName, time: getUTC3Time().getTime() };
                await updateDoc(deviceRef, updates);
            } else if (currentBooking.uid === currentUser.uid || isAdmin) {
                if (confirm("取消该预约？")) {
                    const updates = {};
                    updates[`bookings.${slotIndex}`] = null;
                    await updateDoc(deviceRef, updates);
                }
            }
        };

        // 初始化
        scheduleRefresh();
        setInterval(updateTimeLine, 60000); // 每一分钟更新一次指针位置
    </script>
    <style>
        .timeline-grid { display: grid; grid-template-columns: repeat(48, 1fr); min-width: 960px; }
        .hour-cell { border-right: 1px solid #f1f5f9; height: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: white; }
        .hour-cell:hover { background-color: #f8fafc; box-shadow: inset 0 0 0 1px #3b82f6; z-index: 5; }
        
        /* 核心改进：红线现在相对于网格定位 */
        .now-indicator { 
            position: absolute; top: 0; bottom: 0; width: 2px; 
            background: #ef4444; z-index: 20; pointer-events: none; 
            display: none; box-shadow: 0 0 4px rgba(239, 68, 68, 0.4);
        }
        
        /* 侧边栏固定 */
        .sticky-side { position: sticky; left: 0; }
        .device-row:nth-child(even) { background-color: #fafafa; }
        .device-row:nth-child(even) .sticky-side { background-color: #fafafa; }

        /* 隐藏滚动条美化 */
        .overflow-x-auto::-webkit-scrollbar { height: 6px; }
        .overflow-x-auto::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    <div class="max-w-[1400px] mx-auto p-4 lg:p-10">
        <header class="bg-slate-900 rounded-3xl p-6 shadow-xl flex justify-between items-center mb-6 border-b-4 border-blue-600">
            <div class="flex items-center gap-6">
                <div>
                    <h1 class="text-xl font-black text-white italic tracking-tighter">SINO <span class="text-blue-500 text-2xl">DEVICE</span></h1>
                    <p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">Global Cloud Service (GMT+3)</p>
                </div>
                <div id="authSection"></div>
            </div>
            
            <div id="adminControls" class="hidden gap-2">
                <input id="deviceNameInput" type="text" placeholder="添加新设备..." class="bg-slate-800 text-white text-[11px] rounded-xl px-4 py-2 border-none outline-none focus:ring-1 focus:ring-blue-500 w-40">
                <button onclick="addDevice()" class="bg-blue-600 hover:bg-blue-500 text-white text-[11px] font-bold px-4 py-2 rounded-xl transition shadow-lg">添加</button>
            </div>
        </header>

        <main id="appContent" class="bg-white rounded-[2rem] shadow-sm border border-slate-200 overflow-hidden opacity-20 transition-all duration-500">
            <div class="overflow-x-auto">
                <div class="flex bg-slate-50/80 border-b border-slate-100 sticky top-0 z-30 backdrop-blur-sm">
                    <div class="w-40 flex-shrink-0 p-3 text-[10px] font-black text-slate-400 uppercase tracking-tighter border-r border-slate-100 bg-slate-50">Device Name</div>
                    <div class="flex-grow timeline-grid relative">
                        <script>
                            for(let i=0; i<24; i++) {
                                document.write(`<div class="col-span-2 text-left pl-1 border-l border-slate-200/50 text-[9px] font-bold text-slate-400 py-2">${i}:00</div>`);
                            }
                        </script>
                        <div class="now-indicator" style="background: #ef4444; width: 2px;"></div>
                    </div>
                </div>

                <div id="deviceList" class="relative"></div>
            </div>
        </main>
        
        <footer class="mt-6 text-center text-slate-400 text-[10px] font-medium italic">
            * 每天零点系统自动重置预约 | 点击格子预约 30 分钟时段 | 管理员可强制取消他人预约
        </footer>
    </div>
</body>
</html>
